# Monitor Rollout process in CDÂ pipeline

The diagram below outlines the key steps involved in the process:

- **Slice the Generated Manifests**: To begin, you can utilize kubectl-slice to separate the YAML files generated by Helm. This allows for individual deployment of each manifest on the Kubernetes cluster.

- **Waiting for Rollout**: Once the manifests are deployed, you can wait for the rollout process to complete. This step enables you to determine which deployments have been successful and which ones require further attention.

<p align="center">
  <img src="pictures/rollout.png?raw=true" />
</p>

You can follow these steps to deploy your workloads and monitor the rollout progress:

```bash
$ helm template --debug -n ${NAMESPACE} ${PROJECT_NAME} \
  ./helm-chart/ > all_manifests.yaml
$
$ kubectl-slice --input-file=all_manifests.yaml --output-dir=manifests
```

rolling out script:

```bash
#!/bin/bash

cd manifests

KUBERNETES_NAMESPACE=`echo ${CI_PROJECT_NAMESPACE##*/}`

if [ -f deployment* ]
then
  for file in deployment*
  do
      deployment_name=${file#"deployment-"}
      deployment_name=${deployment_name%".yaml"}
      
      kubectl rollout status deployment $deployment_name -n $KUBERNETES_NAMESPACE --timeout=1000s
  done
fi
```

for waiting `statefulsets` you can use the following code: 

```bash
if [ -f statefulset* ]
then
  for file in statefulset*
  do
      statefulset_name=${file#"statefulset-"}
      statefulset_name=${statefulset_name%".yaml"}
      
      kubectl rollout status statefulset $statefulset_name -n $KUBERNETES_NAMESPACE --timeout=1000s
  done
fi
```

for waiting `statefulsets` you can use the following code: 
```bash
if [ -f job* ]
then
  for file in job*
  do
      job_name=${file#"job-"}
      job_name=${job_name%".yaml"}
      
      kubectl wait --for=condition=complete job/$job_name -n $KUBERNETES_NAMESPACE --timeout=1800s &
      completion_pid=$!

      kubectl wait --for=condition=failed job/$job_name -n $KUBERNETES_NAMESPACE --timeout=1800s && exit 1 &
      failure_pid=$! 

      wait -n $completion_pid $failure_pid

  done
```
